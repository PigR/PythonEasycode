<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конвертер валют</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .currency-flag {
            font-size: 1.5em;
            margin-right: 10px;
        }
        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-white">
                        <h1 class="text-center mb-0">
                            <i class="fas fa-exchange-alt"></i> Конвертер валют
                        </h1>
                    </div>
                    <div class="card-body">
                        <!-- Панель управления -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-sync-alt"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">Последнее обновление</h6>
                                        <small id="lastUpdateText" class="text-muted">
                                            {% if last_update %}
                                                {{ last_update.strftime('%Y-%m-%d %H:%M:%S') }}
                                            {% else %}
                                                Данные еще не обновлялись
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button id="updateRatesBtn" class="btn btn-primary">
                                    <i class="fas fa-redo"></i> Обновить курсы
                                </button>
                            </div>
                        </div>

                        <!-- Форма конвертации -->
                        <form id="conversionForm">
                            <div class="row g-3">
                                <div class="col-md-5">
                                    <label class="form-label">Из валюты</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </span>
                                        <select class="form-select" id="fromCurrency" required>
                                            <option value="">Выберите валюту</option>
                                            {% for currency in currencies %}
                                                <option value="{{ currency }}">{{ currency }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-2 text-center">
                                    <button type="button" id="swapCurrencies" class="btn btn-outline-secondary mt-4">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                </div>
                                
                                <div class="col-md-5">
                                    <label class="form-label">В валюту</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </span>
                                        <select class="form-select" id="toCurrency" required>
                                            <option value="">Выберите валюту</option>
                                            {% for currency in currencies %}
                                                <option value="{{ currency }}">{{ currency }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <label class="form-label">Сумма</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-calculator"></i>
                                        </span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="amount" 
                                               step="0.01" 
                                               min="0.01" 
                                               placeholder="Введите сумму" 
                                               required>
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-exchange-alt"></i> Конвертировать
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Результат -->
                        <div class="result-box" id="resultBox">
                            <h5 class="text-center mb-3">Результат конвертации</h5>
                            <div class="text-center">
                                <h2 id="conversionResult" class="display-4 mb-3"></h2>
                                <p id="conversionDetails" class="text-muted"></p>
                            </div>
                        </div>

                        <!-- Сообщения об ошибках -->
                        <div class="alert alert-danger mt-3" id="errorAlert" style="display: none;"></div>

                        <!-- Загрузка -->
                        <div class="loading" id="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <p class="mt-2">Обработка запроса...</p>
                        </div>
                    </div>
                </div>

                <!-- Информация о доступных валютах -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-coins"></i> Доступные валюты
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="currencyList">
                            {% for currency in currencies[:12] %}
                                <div class="col-6 col-md-3 mb-2">
                                    <span class="badge bg-primary">{{ currency }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Обновление курсов валют
        document.getElementById('updateRatesBtn').addEventListener('click', function() {
            showLoading();
            fetch('/api/update_rates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    alert(data.message);
                    if (data.last_update) {
                        document.getElementById('lastUpdateText').textContent = data.last_update;
                    }
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                hideLoading();
                showError('Ошибка сети: ' + error.message);
            });
        });

        // Обработка формы конвертации
        document.getElementById('conversionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fromCurrency = document.getElementById('fromCurrency').value;
            const toCurrency = document.getElementById('toCurrency').value;
            const amount = document.getElementById('amount').value;
            
            // Валидация
            if (!fromCurrency || !toCurrency || !amount) {
                showError('Пожалуйста, заполните все поля');
                return;
            }
            
            if (fromCurrency === toCurrency) {
                showError('Пожалуйста, выберите разные валюты');
                return;
            }
            
            if (parseFloat(amount) <= 0) {
                showError('Сумма должна быть больше 0');
                return;
            }
            
            showLoading();
            
            // Отправка запроса на конвертацию
            fetch('/api/convert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    from_currency: fromCurrency,
                    to_currency: toCurrency,
                    amount: parseFloat(amount)
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.success) {
                    showResult(data);
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                hideLoading();
                showError('Ошибка сети: ' + error.message);
            });
        });

        // Обмен валютами местами
        document.getElementById('swapCurrencies').addEventListener('click', function() {
            const fromCurrency = document.getElementById('fromCurrency');
            const toCurrency = document.getElementById('toCurrency');
            
            const temp = fromCurrency.value;
            fromCurrency.value = toCurrency.value;
            toCurrency.value = temp;
        });

        // Функция показа результата
        function showResult(data) {
            const resultBox = document.getElementById('resultBox');
            const resultText = document.getElementById('conversionResult');
            const detailsText = document.getElementById('conversionDetails');
            
            resultText.textContent = `${data.amount} ${data.from_currency} = ${data.result} ${data.to_currency}`;
            detailsText.textContent = `1 ${data.from_currency} = ${(data.result / data.amount).toFixed(4)} ${data.to_currency}`;
            
            resultBox.style.display = 'block';
            document.getElementById('errorAlert').style.display = 'none';
        }

        // Функция показа ошибки
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            
            document.getElementById('resultBox').style.display = 'none';
        }

        // Функции показа/скрытия загрузки
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultBox').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Получение времени последнего обновления при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/last_update')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.last_update) {
                        document.getElementById('lastUpdateText').textContent = data.last_update;
                    }
                });
        });
    </script>
</body>
</html>